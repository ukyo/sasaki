// License: MIT https://github.com/ukyo/promiseAplusImpl
(function(t,e){e.Deferred=t;var n,r,i=function(t,e){return function(){return t.apply(e,arguments)}},o=[].slice;r=function(){function t(t){this._deferred=t}return t.prototype.then=function(t,e){return this._deferred._queue.push({onResolved:t,onRejected:e}),this},t.prototype.done=function(t){return this.then(t)},t.prototype.fail=function(t){return this.then(null,t)},t.prototype.always=function(t){return this.then(t,t)},t}(),n=function(){function t(){this.rejectWith=i(this.rejectWith,this),this.reject=i(this.reject,this),this.resolveWith=i(this.resolveWith,this),this.resolve=i(this.resolve,this),this._queue=[],this._context=null}var e;return e=[].slice,t.prototype._transition=function(e,n){var r,i,u,s,h,c,l,f=this;if(this._queue.length){if(r=this._queue.shift(),u=e?r.onResolved:r.onRejected,"function"!=typeof u)return this._transition(e,n);try{return c=u.apply(this._context,n),t.isPromise(c)?(l=function(){var t;return null!=(null!=(t=c._deferred)?t._context:void 0)?f._context=c._deferred._context:void 0},h=function(){var t;return t=arguments.length>=1?o.call(arguments,0):[],l(),f.resolve.apply(f,t)},s=function(t){return l(),f.reject(t)},c.then(h,s)):this.resolve(c)}catch(a){return i=a,this.reject(i)}}},t.prototype.resolve=function(){return this._transition(!0,arguments)},t.prototype.resolveWith=function(){var t,e;return e=arguments[0],t=arguments.length>=2?o.call(arguments,1):[],this._context=e,this._transition(!0,t)},t.prototype.reject=function(){return this._transition(!1,arguments)},t.prototype.rejectWith=function(){var t,e;return e=arguments[0],t=arguments.length>=2?o.call(arguments,1):[],this._context=e,this._transition(!1,t)},t.prototype.then=function(t,e){return this._queue.push({onResolved:t,onRejected:e}),this},t.prototype.done=function(t){return this.then(t)},t.prototype.fail=function(t){return this.then(null,t)},t.prototype.always=function(t){return this.then(t,t)},t.prototype.promise=function(){return new r(this)},t}(),n.isPromise=function(t){return t&&"function"==typeof t.then},n.when=function(){var t,e,r,i,u,s,h;return t=arguments.length>=1?o.call(arguments,0):[],1===t.length&&Array.isArray(t[0])&&(t=t[0]),r=new n,h=[],e=t.length,i=!1,s=function(t,n){return i?void 0:(h[t]=1===n.length?n[0]:n,--e?void 0:r.resolve.apply(r,h))},u=function(t){return i?void 0:(i=!0,r.reject(t))},t.forEach(function(t,e){return n.isPromise(t)?t.then(function(){var t;return t=arguments.length>=1?o.call(arguments,0):[],s(e,t)},u):s(e,t)}),r.promise()},"function"==typeof define&&null!=define.amd?define(function(){return n}):null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=n:e.Deferred=n})({},function(){return this}());
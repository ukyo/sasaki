// License: MIT https://github.com/ukyo/promiseAplusImpl
(function(t,e){e.Deferred=t;var n,r=[].slice;n=function(){function t(){var e=this;this.rejectWith=function(){var n,o;return o=arguments[0],n=arguments.length>=2?r.call(arguments,1):[],e._context=o,t.prototype.rejectWith.apply(e,arguments)},this.reject=function(){var n;return n=arguments.length>=1?r.call(arguments,0):[],t.prototype.reject.apply(e,arguments)},this.resolveWith=function(){var n,o;return o=arguments[0],n=arguments.length>=2?r.call(arguments,1):[],e._context=o,t.prototype.resolveWith.apply(e,arguments)},this.resolve=function(){var n;return n=arguments.length>=1?r.call(arguments,0):[],t.prototype.resolve.apply(e,arguments)},this._transition=function(){return t.prototype._transition.apply(e,arguments)},this._queue=[],this._context=null}var e;return e=function(){function t(t){this._deferred=t}return t.prototype.then=function(t,e){return this._deferred._queue.push({onResolved:t,onRejected:e}),this},t.prototype.done=function(t){return this.then(t)},t.prototype.fail=function(t){return this.then(null,t)},t.prototype.always=function(t){return this.then(t,t)},t}(),t.prototype._transition=function(e,n){var o,u,i,s,a,l,c=this;if(this._queue.length){if(o=this._queue.shift(),u=e?o.onResolved:o.onRejected,"function"!=typeof u)return this.resolve.apply(this,n);try{return a=u.apply(this._context,n),t.isPromise(a)?(l=function(){var t;return null!=(null!=(t=a._deferred)?t._context:void 0)?c._context=a._deferred._context:void 0},s=function(){var t;return t=arguments.length>=1?r.call(arguments,0):[],l(),c.resolve.apply(c,t)},i=function(t){return l(),c.reject(t)},a.then(s,i)):this.resolve(a)}catch(h){return this.reject(h)}}},t.prototype.resolve=function(){var t;return t=arguments.length>=1?r.call(arguments,0):[],this._transition(!0,t)},t.prototype.resolveWith=function(){var t,e;return e=arguments[0],t=arguments.length>=2?r.call(arguments,1):[],this._context=e,this._transition(!0,t)},t.prototype.reject=function(){var t;return t=arguments.length>=1?r.call(arguments,0):[],this._transition(!1,t)},t.prototype.rejectWith=function(){var t,e;return e=arguments[0],t=arguments.length>=2?r.call(arguments,1):[],this._context=e,this._transition(!1,t)},t.prototype.then=function(t,e){return this._queue.push({onResolved:t,onRejected:e}),this},t.prototype.done=function(t){return this.then(t)},t.prototype.fail=function(t){return this.then(null,t)},t.prototype.always=function(t){return this.then(t,t)},t.prototype.promise=function(){return new e(this)},t}(),n.isPromise=function(t){return t&&"function"==typeof t.then},n.when=function(){var t,e,o,u,i,s,a;return t=arguments.length>=1?r.call(arguments,0):[],1===t.length&&Array.isArray(t[0])&&(t=t[0]),o=new n,a=[],e=t.length,u=!1,s=function(t,n){return u?void 0:(a[t]=1===n.length?n[0]:n,--e?void 0:o.resolve.apply(o,a))},i=function(t){return u?void 0:(u=!0,o.reject(t))},t.forEach(function(t,e){return n.isPromise(t)?t.then(function(){var t;return t=arguments.length>=1?r.call(arguments,0):[],s(e,t)},i):s(e,t)}),o.promise()},"function"==typeof define&&null!=define.amd?define(function(){return n}):null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=n:e.Deferred=n})({},function(){return this}());